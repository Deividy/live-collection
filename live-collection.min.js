(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};m=this._,c=this.F,k=this.lineWrapper=function(a,b){return new g(a,b)},l=[188,190,8,9,46,48,49,50,51,52,53,54,55,56,57,96,97,98,99,100,101,102,103,104,105,110],g=function(){function b(a,b,d){var e,f,g,h,i,j;for(this.$=a,this.attributes=b,this.attributeConfig=null!=d?d:{},c.demandSelector(this.$,"$"),c.demandArrayOfGoodStrings(this.attributes,"attributes"),this.fields={},this.textFields={},j=this.attributes,h=0,i=j.length;i>h;h++)g=j[h],e=this.$.find("[name='"+g+"']"),f=this.$.find("."+g),e.length>0?this.fields[g]=e:f.length>0&&(this.textFields[g]=f);this.bindEvents()}return b.prototype.bindEvents=function(){var a,b,c;c=this.fields;for(b in c)a=c[b],a.on("keydown",this.onFieldKeyDown),a.on("focus",this.onFieldFocus)},b.prototype.onFieldFocus=function(b){var c,d;return c=a(b.currentTarget),d=b.currentTarget.name,n.call(this.attributeConfig.numbers,d)>=0&&0===Number(c.val())?c.val(""):void 0},b.prototype.onFieldKeyDown=function(a){var b,d;return c.demandGoodNumber(a.keyCode,"ev.keyCode"),c.demandFunction(a.preventDefault,"ev.preventDefault"),b=a.currentTarget.name,n.call(this.attributeConfig.numbers,b)>=0&&(d=a.keyCode,n.call(l,d)<0)?a.preventDefault():void 0},b.prototype.populate=function(a){var b,c;for(b in a)c=a[b],null!=this.fields[b]&&this.fields[b].val(c),null!=this.textFields[b]&&this.textFields[b].html(c)},b.prototype.destroy=function(){return this.$.remove()},b}(),k.Class=g,b=this.Backbone,m=this._,c=this.F,k=this.liveWrapper,i=this.liveModel=function(a,b){return new e(a,b)},e=function(){function b(a,b){var d,e;this.originalData=a,this.liveCollection=b,c.demandGoodObject(this.originalData,"originalData"),c.demandGoodNumber(this.originalData.id,"originalData.id"),c.demandGoodObject(this.liveCollection,"liveCollection"),this.attributes=null!=(d=this.liveCollection.attributes)?d:m.keys(this.originalData),this.attributeConfig=null!=(e=this.liveCollection.attributeConfig)?e:{},m.extend(this,m.pick(this.originalData,this.attributes)),this.previousValues={},this.liveWrappers=[],this.refresh(),this.isLiveModel=!0}return b.prototype.refresh=function(){return this.previousValues=m.pick(this,this.attributes)},b.prototype.initWrappers=function(b){var d,e,f,g;for(this.lastSelector=b,c.demandGoodString(this.lastSelector,"lastSelector"),g=a(this.lastSelector),e=0,f=g.length;f>e;e++)d=g[e],this.wrap(a(d))},b.prototype.wrap=function(a){var b;return c.demandSelector(a,"$container"),b=k(a,this.attributes),this.lineWrappers.push(b),this.bindEvents(b),this.forcePopulate(b),b},b.prototype.resetWrappers=function(){return this.lineWrappers=[]},b.prototype.isDirty=function(){return this.dirtyAttributes().length>0},b.prototype.dirtyAttributes=function(){var a,b,c,d,e;for(b=[],e=this.attributes,c=0,d=e.length;d>c;c++)a=e[c],this[a]!==this.previousValues[a]&&b.push(a);return b},b.prototype.changes=function(){var a,b,c,d,e,f,g,h;for(b=this.dirtyAttributes(),a={id:this.id,newValues:m.pick(this,b),previousValues:m.pick(this.previousValues,b)},h=a.newValues,e=f=0,g=h.length;g>f;e=++f)c=h[e],d=a.previousValues[c],a.newValues[c]=this.sanitizeValue(c,e),a.previousValues[c]=this.sanitizeValue(c,d);return a},b.prototype.sanitizeValue=function(a,b){return c.demandGoodString(a,"attribute"),b},b.prototype.setValue=function(a,b){var d;return c.demandGoodString(a,"attribute"),b=this.sanitizeValue(a,b),d=this[a]!==b,this[a]=b,d?this.liveCollection.trigger("model:change",a,b,this):void 0},b.prototype.setValues=function(a){var b,d,e;c.demandGoodObject(a,"values"),e=[];for(b in a)d=a[b],e.push(this.setValue(b,d));return e},b.prototype.applyChanges=function(){var a,b,c,d,e,f,g,h,i,j;for(c={},h=this.attributes,d=0,f=h.length;f>d;d++)a=h[d],this[a]!==this.previousValues[a]&&(c[a]=this[a]);if(!m.isEmpty(c)){for(i=this.lineWrappers,j=[],e=0,g=i.length;g>e;e++)b=i[e],j.push(b.populate(c));return j}},b.prototype.destroy=function(){var a,b,c,d;for(d=this.lineWrappers,b=0,c=d.length;c>b;b++)a=d[b],a.destroy();return delete this},b.prototype.$=function(){var b,c,d,e,f;if(b=a(),0===this.lineWrappers.length)return b;for(f=this.lineWrappers,d=0,e=f.length;e>d;d++)c=f[d],b=b.add(c.$);return b},b}(),i.Class=e,b=this.Backbone,m=this._,i=this.liveModel,h=this.liveCollection=function(a){return new d(a)},d=function(){function a(a){null==a&&(a={}),m.extend(this,a),m.extend(this,b.Events),this.items=[],this.sorted=null!=this.sortFn,this.byId={},null==this.workflowVersion&&(this.workflowVersion=0),null!=a.items&&this.reset(a.items,a.preSorted),this.queueById={},this.lastSave=[],this.isRunning=!1,this.debounceSave=m.debounce(this.save,100)}return a.prototype.doSave=function(){throw new Error("Not Implemented")},a.prototype.doDelete=function(){throw new Error("Not Implemented")},a.prototype.doAdd=function(){throw new Error("Not Implemented")},a.prototype.comparator=function(){return 0},a.prototype.belongs=function(){return!0},a.prototype.isFresher=function(){return!0},a.prototype.save=function(){var a,b,c,d,e;if(!m.isEmpty(this.queueById)&&!this.isRunning){for(this.lastSave=[],e=m.values(this.queueById),c=0,d=e.length;d>c;c++)b=e[c],b.isDirty()&&(a=b.changes(),a.id=b.id,this.lastSave.push(a));if(this.queueById={},!m.isEmpty(update))return this.isRunning=!0,this.doSave(updates,m.bind(this.finishSave,this))}},a.prototype.finishSave=function(a){return m.each(this.lastSave,function(b){return function(c){var d,e;return d=b.byId[c.id],e=a[c.id],m.extend(d.previousValues,c.newValues),b.applyDbValues(c.id,e)}}(this)),this.isRunning=!1,this.workflowVersion++,this.trigger("change:workflowVersion",this.workflowVersion),this.checkWorkflowVersion(data.workflowVersion),this.trigger("save:done",this.workflowVersion),this.debounceSave()},a.prototype._preAdd=function(a){return a.isLiveModel?a.liveCollection===this?a:i(m.pick(a,a.attributes),this):i(a,this)},a.prototype._compare=function(a,b){return this.comparator.call(this,a,b)||this.comparePrimitive(a.id,b.id)},a.prototype.comparePrimitive=function(a,b){return m.isString(a)&&m.isString(b)&&(a=a.toLowerCase(),b=b.toLowerCase()),a.valueOf()===b.valueOf()?0:b>a?-1:1},a.prototype.reset=function(a){var b,c,d,e;if(!m.isArray(a))throw new Error("items must be an array");for(this.items=[],this.byId={},d=0,e=a.length;e>d;d++)c=a[d],this.belongs(c)&&(c=this._preAdd(c),this.byId[c.id]=c,this.items.push(c));return b=m.bind(this.comparator,this),this.items.sort(b),this.trigger("reset",this.items,this.items.length),this.trigger("count",this.items.length),this},a.prototype.merge=function(a){var b,c,d;if(m.isArray(a))for(c=0,d=a.length;d>c;c++)b=a[c],this._mergeOne(b);else{if(!m.isObject(a))throw new Error("Data must be either an array or an object");this._mergeOne(a)}return this},a.prototype._mergeOne=function(a){var b,c;if(null==a.id)throw new Error("id must not be nil");return b=this.byId[a.id],null!=b?this._update(a,b):this.belongs(a)?(a=this._preAdd(a),this.byId[a.id]=a,c=this.binarySearch(a),this.items.splice(c,0,a),this.trigger("add",a,c),this.trigger("count",this.items.length)):void 0},a.prototype._update=function(a,b){var c,d,e,f,g,h;if(this.isFresher(a,b)){for(d=this.binarySearch(b),e=!1,h=b.attributes,f=0,g=h.length;g>f;f++)c=h[f],b[c]!==a[c]&&(e=!0,b.setValue(c,a[c]));if(e)return this.belongs(b)?this.hasRightIndex(b,d)?this.trigger("update",b,d):(this.remove(b,d),this.merge(b)):this.remove(b,d)}},a.prototype.indexOf=function(a){var b;return b=this.get(a),this.binarySearch(b)},a.prototype.get=function(a){var b;if(b=this.tryGet(a),null!=b)return b;throw new Error("Did not find object or id "+JSON.stringify(a))},a.prototype.tryGet=function(a){var b,c;return b=null!=(c=a.id)?c:a,this.byId[b]},a.prototype.binarySearch=function(a){var b,c,d,e;if(0===this.items.length)return 0;for(c=0,e=this.items.length-1;e>=c;)if(d=c+e>>1,b=this._compare(a,this.items[d]),b>0&&(c=d+1),0>b&&(e=d-1),0===b)return d;return b>0?d+1:d},a.prototype.hasRightIndex=function(a,b){return b>0&&this._compare(this.items[b-1],a)>=0?!1:b<this.items.length-1&&this._compare(a,this.items[b+1])>=0?!1:!0},a.prototype.remove=function(a,b){var c;return c=this.tryGet(a),null!=c?(null==b&&(b=this.binarySearch(c)),delete this.byId[c.id],this.items.splice(b,1),this.trigger("remove",c,b),this.trigger("count",this.items.length),this):void 0},a}(),h.Class=d,a=this.$,m=this._,j=this.liveRender=function(a){return new f(a)},f=function(){function b(b){var c,d,e,f;null==b&&(b={}),null==this.render&&(d=a(b.template).html(),e=null!=(f=b.templateVariable)?f:"data",c=m.template(d,null,{variable:e}),this.render=function(a){return c(a)}),this.container=a(b.container),this.lc=b.liveCollection,this.lc.on("add",this.add,this),this.lc.on("update",this.update,this),this.lc.on("remove",this.remove,this),this.lc.on("reset",this.reset,this),m.isFunction(b.onCount)&&this.lc.on("count",b.onCount,this),m.isFunction(b.onClick)&&this.container.on("click",function(a){return function(c){return a.click(c,b.onClick)}}(this))}return b.prototype.click=function(b,c){var d,e,f,g;if(d=a(b.target).closest("[data-rowid]"),0===d.length)throw g='Unable to find containing element for click. You must render each data row within an HTML element with a "data-rowid" attribute',new Error(g);if(d.length>1)throw new Error("Found multiple containing elements for click");return e=Number(d.data("rowid")),f=this.lc.get(e),c(f)},b.prototype.add=function(b,c){var d,e;return e=this.render(b).trim(),d=a(e).hide(),0===c?d.prependTo(this.container).fadeIn():d.insertAfter(this.container.children().eq(c-1)).fadeIn()},b.prototype.update=function(a,b){var c;return c=this.render(a).trim(),this.container.children().eq(b).replaceWith(c)},b.prototype.remove=function(a,b){return this.container.children().eq(b).remove()},b.prototype.reset=function(a){var b,c;return b=function(){var b,d,e;for(e=[],b=0,d=a.length;d>b;b++)c=a[b],e.push(this.render(c));return e}.call(this),this.container.html(b)},b.prototype.count=function(a){return this.count.text(a)},b}(),j.Class=f}).call(this);