(function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}},g=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};this.liveCollection=function(b){return new a(b)},a=function(){function a(a){null==a&&(a={}),_.extend(this,a),_.extend(this,Backbone.Events),this.items=[],this.sorted=null!=this.sortFn,this.byId={},null==this.workflowVersion&&(this.workflowVersion=0),null!=a.items&&this.reset(a.items,a.preSorted),this.queueById={},this.lastSave=[],this.isRunning=!1,this.debounceSave=_.debounce(this.save,100)}return a.prototype.doSave=function(){throw new Error("Not Implemented")},a.prototype.doDelete=function(){throw new Error("Not Implemented")},a.prototype.doAdd=function(){throw new Error("Not Implemented")},a.prototype.comparator=function(){return 0},a.prototype.belongs=function(){return!0},a.prototype.isFresher=function(){return!0},a.prototype.save=function(){var a,b,c,d,e;if(!_.isEmpty(this.queueById)&&!this.isRunning){for(this.lastSave=[],e=_.values(this.queueById),c=0,d=e.length;d>c;c++)b=e[c],b.isDirty()&&(a=b.changes(),a.id=b.id,this.lastSave.push(a));if(this.queueById={},!_.isEmpty(update))return this.isRunning=!0,this.doSave(updates,_.bind(this.finishSave,this))}},a.prototype.finishSave=function(a){return _.each(this.lastSave,function(b){return function(c){var d,e;return d=b.byId[c.id],e=a[c.id],_.extend(d.previousValues,c.newValues),b.applyDbValues(c.id,e)}}(this)),this.isRunning=!1,this.workflowVersion++,this.trigger("change:workflowVersion",this.workflowVersion),this.checkWorkflowVersion(data.workflowVersion),this.trigger("save:done",this.workflowVersion),this.debounceSave()},a.prototype._preAdd=function(a){return a.isLiveModel?a.liveCollection===this?a:liveModel(_.pick(a,a.attributes),this):liveModel(a,this)},a.prototype._compare=function(a,b){return this.comparator.call(this,a,b)||this.comparePrimitive(a.id,b.id)},a.prototype.comparePrimitive=function(a,b){return _.isString(a)&&_.isString(b)&&(a=a.toLowerCase(),b=b.toLowerCase()),a.valueOf()===b.valueOf()?0:b>a?-1:1},a.prototype.reset=function(a){var b,c,d,e;if(!_.isArray(a))throw new Error("items must be an array");for(this.items=[],this.byId={},d=0,e=a.length;e>d;d++)c=a[d],this.belongs(c)&&(c=this._preAdd(c),this.byId[c.id]=c,this.items.push(c));return b=_.bind(this.comparator,this),this.items.sort(b),this.trigger("reset",this.items,this.items.length),this.trigger("count",this.items.length),this},a.prototype.merge=function(a){var b,c,d;if(_.isArray(a))for(c=0,d=a.length;d>c;c++)b=a[c],this._mergeOne(b);else{if(!_.isObject(a))throw new Error("Data must be either an array or an object");this._mergeOne(a)}return this},a.prototype._mergeOne=function(a){var b,c;if(null==a.id)throw new Error("id must not be nil");return b=this.byId[a.id],null!=b?this._update(a,b):this.belongs(a)?(a=this._preAdd(a),this.byId[a.id]=a,c=this.binarySearch(a),this.items.splice(c,0,a),this.trigger("add",a,c),this.trigger("count",this.items.length)):void 0},a.prototype._update=function(a,b){var c,d,e,f,g,h;if(this.isFresher(a,b)){for(d=this.binarySearch(b),e=!1,h=b.attributes,f=0,g=h.length;g>f;f++)c=h[f],b[c]!==a[c]&&(e=!0,b.setValue(c,a[c]));if(e)return this.belongs(b)?this.hasRightIndex(b,d)?this.trigger("update",b,d):(this.remove(b,d),this.merge(b)):this.remove(b,d)}},a.prototype.indexOf=function(a){var b;return b=this.get(a),this.binarySearch(b)},a.prototype.get=function(a){var b;if(b=this.tryGet(a),null!=b)return b;throw new Error("Did not find object or id "+JSON.stringify(a))},a.prototype.tryGet=function(a){var b,c;return b=null!=(c=a.id)?c:a,this.byId[b]},a.prototype.binarySearch=function(a){var b,c,d,e;if(0===this.items.length)return 0;for(c=0,e=this.items.length-1;e>=c;)if(d=c+e>>1,b=this._compare(a,this.items[d]),b>0&&(c=d+1),0>b&&(e=d-1),0===b)return d;return b>0?d+1:d},a.prototype.hasRightIndex=function(a,b){return b>0&&this._compare(this.items[b-1],a)>=0?!1:b<this.items.length-1&&this._compare(a,this.items[b+1])>=0?!1:!0},a.prototype.remove=function(a,b){var c;return c=this.tryGet(a),null!=c?(null==b&&(b=this.binarySearch(c)),delete this.byId[c.id],this.items.splice(b,1),this.trigger("remove",c,b),this.trigger("count",this.items.length),this):void 0},a}(),this.liveCollection.Class=a,this.liveModel=function(a,c){return new b(a,c)},b=function(){function a(a,b){var c,d;this.originalData=a,this.liveCollection=b,F.demandGoodObject(this.originalData,"originalData"),F.demandGoodNumber(this.originalData.id,"originalData.id"),F.demandGoodObject(this.liveCollection,"liveCollection"),this.attributes=null!=(c=this.liveCollection.attributes)?c:_.keys(this.originalData),this.attributeConfig=null!=(d=this.liveCollection.attributeConfig)?d:{},_.extend(this,_.pick(this.originalData,this.attributes)),this.previousValues={},this.liveWrappers=[],this.refresh(),this.isLiveModel=!0}return a.prototype.refresh=function(){return this.previousValues=_.pick(this,this.attributes)},a.prototype.initWrappers=function(a){var b,c,d,e;for(this.lastSelector=a,F.demandGoodString(this.lastSelector,"lastSelector"),this.resetWrappers(),e=$(this.lastSelector),c=0,d=e.length;d>c;c++)b=e[c],this.wrap($(b))},a.prototype.wrap=function(a){var b;return b=liveWrapper(a,this.attributes),this.liveWrappers.push(b),this.bindEvents(b),b},a.prototype.resetWrappers=function(){return this.liveWrappers=[]},a.prototype.getWrapper=function(a){var b,c,d,e,f;for(b=this.$(),f=this.liveWrappers,d=0,e=f.length;e>d;d++)if(c=f[d],b.index(c.$)===b.index(a))return c;throw new Error("Wrapper not found for "+a)},a.prototype.$=function(){var a,b,c,d,e;if(a=$(),0===this.liveWrappers.length)return a;for(e=this.liveWrappers,c=0,d=e.length;d>c;c++)b=e[c],a=a.add(b.$);return a},a.prototype.bindEvents=function(a){var b,c,d;F.demandGoodObject(a,"lw"),d=a.fields;for(c in d)b=d[c],b.on("keyup",_.bind(this.onFieldKeyUp,this)),b.on("change",_.bind(this.onFieldChange,this))},a.prototype.onFieldKeyUp=function(a){return this.setValue(a.currentTarget.name,$(a.currentTarget).val())},a.prototype.onFieldChange=function(a){var b,c,d;return F.demandFunction(a.preventDefault,"ev.preventDefault"),a.preventDefault(),b=$(a.currentTarget).closest("[data-rowid]"),c=a.currentTarget.name,d=$(a.currentTarget).val(),this.setValue(c,d)},a.prototype.setValue=function(a,b){var c;return F.demandGoodString(a,"attribute"),b=this.sanitizeValue(a,b),c=this[a]!==b,this[a]=b,c&&this.liveCollection.trigger("model:change",a,b,this),this.setValueInWrappers(a,b)},a.prototype.setValues=function(a){var b,c,d;F.demandGoodObject(a,"values"),d=[];for(b in a)c=a[b],d.push(this.setValue(b,c));return d},a.prototype.setValueInWrappers=function(a,b){var c,d,e,f;for(f=this.liveWrappers,d=0,e=f.length;e>d;d++)c=f[d],c.fields[a]?c.fields[a].val(b):c.textFields[a]&&c.textFields[a].html(b)},a.prototype.sanitizeValue=function(a,b){return F.demandGoodString(a,"attribute"),b},a.prototype.applyChanges=function(){var a,b,c,d,e,f,g,h,i,j;for(c={},h=this.attributes,d=0,f=h.length;f>d;d++)a=h[d],this[a]!==this.previousValues[a]&&(c[a]=this[a]);if(!_.isEmpty(c)){for(i=this.liveWrappers,j=[],e=0,g=i.length;g>e;e++)b=i[e],j.push(b.populate(c));return j}},a.prototype.isDirty=function(){return this.dirtyAttributes().length>0},a.prototype.dirtyAttributes=function(){var a,b,c,d,e;for(b=[],e=this.attributes,c=0,d=e.length;d>c;c++)a=e[c],this[a]!==this.previousValues[a]&&b.push(a);return b},a.prototype.changes=function(){var a,b,c,d,e,f,g,h;for(b=this.dirtyAttributes(),a={id:this.id,newValues:_.pick(this,b),previousValues:_.pick(this.previousValues,b)},h=a.newValues,e=f=0,g=h.length;g>f;e=++f)c=h[e],d=a.previousValues[c],a.newValues[c]=this.sanitizeValue(c,e),a.previousValues[c]=this.sanitizeValue(c,d);return a},a.prototype.destroy=function(){var a,b,c,d;for(d=this.liveWrappers,b=0,c=d.length;c>b;b++)a=d[b],a.destroy();return delete this},a}(),this.liveModel.Class=b,this.liveRender=function(a){return new c(a)},c=function(){function a(a){var b,c,d,e;null==a&&(a={}),null==this.render&&(c=$(a.template).html(),d=null!=(e=a.templateVariable)?e:"data",b=_.template(c,null,{variable:d}),this.render=function(a){return b(a)}),this.container=$(a.container),this.lc=a.liveCollection,this.lc.on("add",this.add,this),this.lc.on("remove",this.remove,this),this.lc.on("reset",this.reset,this),_.isFunction(a.onCount)&&this.lc.on("count",a.onCount,this),_.isFunction(a.onClick)&&this.container.on("click",function(b){return function(c){return b.click(c,a.onClick)}}(this))}return a.prototype.click=function(a,b){var c,d,e,f;if(c=$(a.target).closest("[data-rowid]"),0===c.length)throw f='Unable to find containing element for click. You must render each data row within an HTML element with a "data-rowid" attribute',new Error(f);if(c.length>1)throw new Error("Found multiple containing elements for click");return d=Number(c.data("rowid")),e=this.lc.get(d),b(e,a)},a.prototype.add=function(a,b){var c,d;return d=this.render(a).trim(),c=$(d).hide(),0===b?c.prependTo(this.container).fadeIn():c.insertAfter(this.container.children().eq(b-1)).fadeIn(),a.wrap(c.find("[data-rowid='"+a.id+"']"))},a.prototype.update=function(a){var b,c;return c=this.lc.binarySearch(a),b=this.render(a).trim(),this.container.children().eq(c).replaceWith(b)},a.prototype.remove=function(a,b){var c,d;return c=this.container.children().eq(b),d=a.getWrapper(c),d.destroy()},a.prototype.reset=function(a){var b,c,d,e,f;for(this.container.html(""),f=[],d=0,e=a.length;e>d;d++)c=a[d],b=this.render(c),this.container.append(b),f.push(c.wrap(this.container.find("[data-rowid='"+c.id+"']")));return f},a.prototype.count=function(a){return this.count.text(a)},a}(),this.liveRender.Class=c,this.liveWrapper=function(a,b,c){return new d(a,b,c)},e=[188,190,8,9,46,48,49,50,51,52,53,54,55,56,57,96,97,98,99,100,101,102,103,104,105,110],d=function(){function a(a,b,c){var d,e,g,h,i,j;for(this.$=a,this.attributes=b,this.attributeConfig=null!=c?c:{},this.onFieldKeyDown=f(this.onFieldKeyDown,this),this.onFieldFocus=f(this.onFieldFocus,this),F.demandArrayOfGoodStrings(this.attributes,"attributes"),this.fields={},this.textFields={},j=this.attributes,h=0,i=j.length;i>h;h++)g=j[h],d=this.$.find("[name='"+g+"']"),e=this.$.find("."+g),d.length>0?this.fields[g]=d:e.length>0&&(this.textFields[g]=e);this.bindEvents()}return a.prototype.bindEvents=function(){var a,b,c;c=this.fields;for(b in c)a=c[b],a.on("keydown",this.onFieldKeyDown),a.on("focus",this.onFieldFocus)},a.prototype.onFieldFocus=function(a){var b,c;return b=$(a.currentTarget),c=a.currentTarget.name,g.call(this.attributeConfig.numbers,c)>=0&&0===Number(b.val())?b.val(""):void 0},a.prototype.onFieldKeyDown=function(a){var b,c;return F.demandGoodNumber(a.keyCode,"ev.keyCode"),F.demandFunction(a.preventDefault,"ev.preventDefault"),b=a.currentTarget.name,g.call(this.attributeConfig.numbers,b)>=0&&(c=a.keyCode,g.call(e,c)<0)?a.preventDefault():void 0},a.prototype.populate=function(a){var b,c;for(b in a)c=a[b],null!=this.fields[b]&&this.fields[b].val(c),null!=this.textFields[b]&&this.textFields[b].html(c)},a.prototype.destroy=function(){return this.$.remove()},a}(),this.liveWrapper.Class=d}).call(this);